[supervisord]
nodaemon=true
logfile=/tmp/supervisord.log
pidfile=/tmp/supervisord.pid
childlogdir=/tmp
loglevel=info

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# X Virtual Framebuffer (headless display)
[program:xvfb]
command=/usr/bin/Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=DISPLAY=":99"
user=patchright

# Window Manager
[program:fluxbox]
command=/usr/bin/fluxbox
autostart=true
autorestart=true
stdout_logfile=/tmp/fluxbox.log
stderr_logfile=/tmp/fluxbox.log
environment=DISPLAY=":99"
user=patchright
depends_on=xvfb

# VNC Server
[program:x11vnc]
command=/usr/bin/x11vnc -display :99 -nopw -rfbport %(ENV_VNC_PORT)s -shared -forever -noxdamage -repeat -wait 5
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=DISPLAY=":99"
user=patchright
depends_on=xvfb

# noVNC Web Interface
[program:novnc]
command=/opt/novnc/utils/websockify/run --web=/opt/novnc 0.0.0.0:%(ENV_NOVNC_PORT)s localhost:%(ENV_VNC_PORT)s
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=patchright
depends_on=x11vnc

# Patchright Chromium CDP Server (starts on demand, not automatically)
[program:patchright_cdp]
command=bash -c 'CHROME_PATH=$(find /ms-playwright -name "chrome" -type f | head -1) && "$CHROME_PATH" --no-sandbox --disable-dev-shm-usage --remote-debugging-port=9222 --remote-debugging-address=0.0.0.0 --disable-gpu --user-data-dir=/tmp/chrome-profile --disable-features=VizDisplayCompositor --disable-web-security --disable-features=TranslateUI --no-first-run --no-default-browser-check --window-size=1920,1080 --start-maximized --disable-blink-features=AutomationControlled --disable-extensions --disable-infobars --disable-logging --silent --no-default-browser-check --disable-default-apps --disable-background-timer-throttling --disable-renderer-backgrounding --disable-backgrounding-occluded-windows --disable-ipc-flooding-protection'
autostart=false
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=DISPLAY=":99",GOOGLE_API_KEY="not_needed",GOOGLE_DEFAULT_CLIENT_ID="not_needed",GOOGLE_DEFAULT_CLIENT_SECRET="not_needed"
user=patchright
depends_on=xvfb

# CDP Port Forwarder (to expose 127.0.0.1:9222 as 0.0.0.0:9222 when browser is running)
[program:cdp_forwarder]
command=socat TCP-LISTEN:9223,fork,reuseaddr TCP:127.0.0.1:9222
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=patchright
depends_on=xvfb

# Browser API FastAPI server (main automation API)
[program:browser_api]
command=/opt/venv/bin/uvicorn browser_api.main:app --host 0.0.0.0 --port %(ENV_API_PORT)s --log-level info
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
directory=/app
environment=PATH="/opt/venv/bin:%(ENV_PATH)s"
user=patchright
depends_on=xvfb

# Additional API server (CDP utilities)
[program:cdp_api]
command=/opt/venv/bin/uvicorn server:app --host 0.0.0.0 --port %(ENV_CDP_API_PORT)s --log-level info
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
directory=/app
environment=PATH="/opt/venv/bin:%(ENV_PATH)s"
user=patchright
depends_on=xvfb
